"""
JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
"""
import json
import os
from datetime import datetime
from typing import Dict, List, Optional, Any
import shutil

# è¨­å®š
JSON_PATH = "progress_data.json"
BACKUP_DIR = "backups"

class ProgressDataManager:
    """é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, json_path: str = JSON_PATH):
        self.json_path = json_path
        self.data = None
        self._ensure_backup_dir()
    
    def _ensure_backup_dir(self):
        """ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ"""
        if not os.path.exists(BACKUP_DIR):
            os.makedirs(BACKUP_DIR)
    
    def load_data(self) -> Dict[str, Any]:
        """JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿"""
        try:
            if not os.path.exists(self.json_path):
                # åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                self._create_initial_data()
            
            with open(self.json_path, 'r', encoding='utf-8') as f:
                self.data = json.load(f)
            
            print(f"âœ… JSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: {len(self.data.get('progress', []))} ä»¶")
            return self.data
            
        except Exception as e:
            print(f"âŒ JSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return self._get_empty_data()
    
    def _create_initial_data(self):
        """åˆæœŸJSONãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ"""
        initial_data = {
            "metadata": {
                "version": "2.0",
                "created_at": datetime.now().isoformat(),
                "total_records": 0
            },
            "students": {},
            "books": [],
            "progress": []
        }
        
        with open(self.json_path, 'w', encoding='utf-8') as f:
            json.dump(initial_data, f, ensure_ascii=False, indent=2)
        
        print(f"ğŸ“„ åˆæœŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ: {self.json_path}")
    
    def _get_empty_data(self) -> Dict[str, Any]:
        """ç©ºã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¿”ã™"""
        return {
            "metadata": {"version": "2.0", "created_at": datetime.now().isoformat()},
            "students": {},
            "books": [],
            "progress": []
        }
    
    def save_data(self) -> bool:
        """JSONãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãï¼‰"""
        try:
            if self.data is None:
                print("âš ï¸ ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
                return False
            
            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
            if os.path.exists(self.json_path):
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                backup_path = os.path.join(BACKUP_DIR, f"progress_data_backup_{timestamp}.json")
                shutil.copy2(self.json_path, backup_path)
                print(f"ğŸ“„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ: {backup_path}")
            
            # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            self.data["metadata"]["last_updated"] = datetime.now().isoformat()
            self.data["metadata"]["total_records"] = len(self.data.get("progress", []))
            
            # ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            with open(self.json_path, 'w', encoding='utf-8') as f:
                json.dump(self.data, f, ensure_ascii=False, indent=2)
            
            file_size = os.path.getsize(self.json_path)
            print(f"âœ… JSONä¿å­˜å®Œäº†: {file_size:,} bytes")
            return True
            
        except Exception as e:
            print(f"âŒ JSONä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def get_students(self, user_filter: Optional[Dict] = None) -> List[str]:
        """ç”Ÿå¾’ä¸€è¦§ã‚’å–å¾—"""
        if not self.data:
            self.load_data()
        
        students = list(self.data.get("students", {}).keys())
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        if user_filter and "campus" in user_filter:
            campus_filter = user_filter["campus"]
            filtered_students = []
            for student_name in students:
                student_info = self.data["students"][student_name]
                if student_info.get("campus") == campus_filter or not campus_filter:
                    filtered_students.append(student_name)
            return filtered_students
        
        return students
    
    def get_progress_data(self, student_name: Optional[str] = None, 
                         user_filter: Optional[Dict] = None) -> List[Dict]:
        """é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        if not self.data:
            self.load_data()
        
        progress_data = self.data.get("progress", [])
        
        # ç”Ÿå¾’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if student_name:
            progress_data = [p for p in progress_data if p.get("student_name") == student_name]
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ ¡èˆåˆ¥ãªã©ï¼‰
        if user_filter and "campus" in user_filter:
            campus_filter = user_filter["campus"]
            if campus_filter:
                # ç”Ÿå¾’ã®æ ¡èˆæƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
                filtered_data = []
                for progress in progress_data:
                    student_info = self.data["students"].get(progress["student_name"], {})
                    if student_info.get("campus") == campus_filter:
                        filtered_data.append(progress)
                progress_data = filtered_data
        
        return progress_data
    
    def add_student(self, student_name: str, username: str = "", campus: str = "") -> bool:
        """æ–°ã—ã„ç”Ÿå¾’ã‚’è¿½åŠ """
        try:
            if not self.data:
                self.load_data()
            
            if student_name in self.data["students"]:
                print(f"âš ï¸ ç”Ÿå¾’ã€Œ{student_name}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™")
                return False
            
            # æ–°ã—ã„ç”Ÿå¾’ã‚’è¿½åŠ 
            self.data["students"][student_name] = {
                "name": student_name,
                "username": username,
                "campus": campus,
                "created_at": datetime.now().isoformat()
            }
            
            # æ—¢å­˜ã®å‚è€ƒæ›¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°ã—ã„ç”Ÿå¾’ç”¨ã®é€²æ—ã‚’ä½œæˆ
            if self.data["books"]:
                existing_progress = self.data.get("progress", [])
                if existing_progress:
                    # æœ€åˆã®ç”Ÿå¾’ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä½¿ç”¨
                    template_student = None
                    for progress in existing_progress:
                        template_student = progress["student_name"]
                        break
                    
                    if template_student:
                        template_progress = [p for p in existing_progress if p["student_name"] == template_student]
                        
                        # æ–°ã—ã„ç”Ÿå¾’ç”¨ã®é€²æ—ã‚’ä½œæˆ
                        new_progress_id = len(existing_progress) + 1
                        for template in template_progress:
                            new_progress = {
                                "id": f"progress_{new_progress_id:06d}",
                                "student_name": student_name,
                                "book_id": template["book_id"],
                                "planned": False,
                                "completed": False,
                                "achievement_percentage": 0.0,
                                "last_updated": datetime.now().isoformat()
                            }
                            self.data["progress"].append(new_progress)
                            new_progress_id += 1
                        
                        print(f"ğŸ“š æ–°ã—ã„ç”Ÿå¾’ç”¨ã«{len(template_progress)}ä»¶ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ")
            
            print(f"ğŸ‘¤ ç”Ÿå¾’ã€Œ{student_name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
            return True
            
        except Exception as e:
            print(f"âŒ ç”Ÿå¾’è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
            return False


def add_new_student_json(df, student_name, current_user_info=None):
    """
    CSVäº’æ›æ€§ã®ãŸã‚ã®ç”Ÿå¾’è¿½åŠ é–¢æ•°
    
    Args:
        df: DataFrameã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆJSONã‹ã‚‰å¤‰æ›ã•ã‚ŒãŸã‚‚ã®ï¼‰
        student_name: è¿½åŠ ã™ã‚‹ç”Ÿå¾’å
        current_user_info: ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆè¾æ›¸ï¼‰
        
    Returns:
        pd.DataFrame: æ›´æ–°ã•ã‚ŒãŸDataFrame
    """
    try:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‹ã‚‰æ ¡èˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
        campus = current_user_info.get('campus', '') if current_user_info else ''
        username = current_user_info.get('username', '') if current_user_info else ''
        
        # ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ç”Ÿå¾’ã‚’è¿½åŠ 
        success = data_manager.add_student(student_name, username, campus)
        
        if success:
            # æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦DataFrameã¨ã—ã¦è¿”ã™
            data_manager.save_data()
            
            # æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§DataFrameã«å¤‰æ›
            updated_data = data_manager.load_data()
            if updated_data and "progress" in updated_data:
                import pandas as pd
                updated_df = pd.DataFrame(updated_data["progress"])
                
                # å¿…è¦ãªåˆ—ã‚’è¿½åŠ /èª¿æ•´
                if not updated_df.empty:
                    # JSONå½¢å¼ã‹ã‚‰ CSVäº’æ›å½¢å¼ã¸ã®å¤‰æ›
                    if "student_name" in updated_df.columns:
                        updated_df = updated_df.rename(columns={"student_name": "ç”Ÿå¾’"})
                    if "planned" in updated_df.columns:
                        updated_df = updated_df.rename(columns={"planned": "äºˆå®š"})
                    if "completed" in updated_df.columns:
                        updated_df = updated_df.rename(columns={"completed": "é”æˆæ¸ˆ"})
                    if "achievement_percentage" in updated_df.columns:
                        updated_df["é”æˆå‰²åˆ"] = updated_df["achievement_percentage"].apply(
                            lambda x: f"{x}%" if x > 0 else ""
                        )
                    
                    # å¿…è¦ãªåˆ—ã‚’è¿½åŠ 
                    required_columns = ["ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«", "ç§‘ç›®", "å‚è€ƒæ›¸å", "æ‰€è¦æ™‚é–“", "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", "æ ¡èˆ"]
                    for col in required_columns:
                        if col not in updated_df.columns:
                            if col == "ãƒ¦ãƒ¼ã‚¶ãƒ¼å":
                                updated_df[col] = updated_df.get("ç”Ÿå¾’", student_name)
                            elif col == "æ ¡èˆ":
                                updated_df[col] = campus
                            else:
                                updated_df[col] = ""
                
                return updated_df
            else:
                return df
        else:
            return df
            
    except Exception as e:
        print(f"âŒ add_new_student_json ã‚¨ãƒ©ãƒ¼: {e}")
        return df
    
    def update_progress(self, student_name: str, book_id: str, 
                       planned: bool = None, completed: bool = None, 
                       achievement_percentage: float = None) -> bool:
        """é€²æ—ã‚’æ›´æ–°"""
        try:
            if not self.data:
                self.load_data()
            
            # è©²å½“ã™ã‚‹é€²æ—ã‚’æ¤œç´¢
            for progress in self.data["progress"]:
                if (progress["student_name"] == student_name and 
                    progress["book_id"] == book_id):
                    
                    # å€¤ã‚’æ›´æ–°
                    if planned is not None:
                        progress["planned"] = planned
                    if completed is not None:
                        progress["completed"] = completed
                    if achievement_percentage is not None:
                        progress["achievement_percentage"] = achievement_percentage
                    
                    progress["last_updated"] = datetime.now().isoformat()
                    print(f"ğŸ“Š é€²æ—æ›´æ–°: {student_name} - {book_id}")
                    return True
            
            print(f"âš ï¸ è©²å½“ã™ã‚‹é€²æ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {student_name} - {book_id}")
            return False
            
        except Exception as e:
            print(f"âŒ é€²æ—æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def get_books(self) -> List[Dict]:
        """å‚è€ƒæ›¸ä¸€è¦§ã‚’å–å¾—"""
        if not self.data:
            self.load_data()
        return self.data.get("books", [])
    
    def to_dataframe(self):
        """pandas DataFrameã«å¤‰æ›ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ç”¨ï¼‰"""
        try:
            import pandas as pd
            
            if not self.data:
                self.load_data()
            
            # é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹ã—ã¦CSVå½¢å¼ã¨åŒã˜æ§‹é€ ã«å¤‰æ›
            rows = []
            books_dict = {book["id"]: book for book in self.data.get("books", [])}
            
            for progress in self.data.get("progress", []):
                book = books_dict.get(progress["book_id"], {})
                student_info = self.data["students"].get(progress["student_name"], {})
                
                row = {
                    "ç”Ÿå¾’": progress["student_name"],
                    "ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«": book.get("route_level", ""),
                    "ç§‘ç›®": book.get("subject", ""),
                    "å‚è€ƒæ›¸å": book.get("name", ""),
                    "æ‰€è¦æ™‚é–“": book.get("estimated_hours", 0.0),
                    "äºˆå®š": progress["planned"],
                    "é”æˆæ¸ˆ": progress["completed"],
                    "é”æˆå‰²åˆ": f"{progress['achievement_percentage']:.1f}%" if progress["achievement_percentage"] > 0 else "",
                    "ãƒ¦ãƒ¼ã‚¶ãƒ¼å": student_info.get("username", ""),
                    "æ ¡èˆ": student_info.get("campus", "")
                }
                rows.append(row)
            
            return pd.DataFrame(rows)
            
        except Exception as e:
            print(f"âŒ DataFrameå¤‰æ›ã‚¨ãƒ©ãƒ¼: {e}")
            import pandas as pd
            return pd.DataFrame()

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
data_manager = ProgressDataManager()

# æ—¢å­˜ã®CSVé–¢æ•°ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤é–¢æ•°
def load_json_data(user_filter=None):
    """JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆCSVé–¢æ•°ã¨ã®äº’æ›æ€§ï¼‰"""
    data_manager.load_data()
    return data_manager.to_dataframe()

def save_json_data(df=None):
    """JSONãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆCSVé–¢æ•°ã¨ã®äº’æ›æ€§ï¼‰"""
    if df is not None:
        # DataFrameã‹ã‚‰JSONã«é€†å¤‰æ›ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
        pass
    return data_manager.save_data()

def add_new_student_json(df=None, student_name: str = None, current_user_info: Dict = None):
    """
    æ–°ã—ã„ç”Ÿå¾’ã‚’JSONã«è¿½åŠ ï¼ˆCSVäº’æ›æ€§ï¼‰
    
    Args:
        df: DataFrameï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰
        student_name: ç”Ÿå¾’å
        current_user_info: ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
        
    Returns:
        pd.DataFrame: æ›´æ–°ã•ã‚ŒãŸDataFrame
    """
    import pandas as pd
    
    try:
        if not student_name:
            print("âš ï¸ ç”Ÿå¾’åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            return df if df is not None else pd.DataFrame()
        
        username = current_user_info.get("username", "") if current_user_info else ""
        campus = current_user_info.get("campus", "") if current_user_info else ""
        
        # JSONã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        success = data_manager.add_student(student_name, username, campus)
        
        if success:
            data_manager.save_data()
            print(f"âœ… ç”Ÿå¾’ '{student_name}' ã‚’JSONã«è¿½åŠ ã—ã¾ã—ãŸ")
            
            # æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’DataFrameå½¢å¼ã§è¿”ã™
            return load_json_data()
        else:
            print(f"âŒ ç”Ÿå¾’ '{student_name}' ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ")
            return df if df is not None else pd.DataFrame()
            
    except Exception as e:
        print(f"âŒ add_new_student_json ã‚¨ãƒ©ãƒ¼: {e}")
        return df if df is not None else pd.DataFrame()


def load_json_data(user_filter=None):
    """
    CSVäº’æ›æ€§ã®ãŸã‚ã®JSONèª­ã¿è¾¼ã¿é–¢æ•°
    
    Args:
        user_filter: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¾æ›¸ {'ç”Ÿå¾’': 'username'} ãªã©
        
    Returns:
        pd.DataFrame: CSVã¨åŒã˜å½¢å¼ã®DataFrame
    """
    try:
        # ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        data = data_manager.load_data()
        
        if not data or "progress" not in data:
            # ç©ºã®DataFrameã‚’è¿”ã™
            import pandas as pd
            return pd.DataFrame(columns=[
                "ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«", "ç§‘ç›®", "å‚è€ƒæ›¸å", "æ‰€è¦æ™‚é–“", "äºˆå®š", "é”æˆæ¸ˆ", 
                "é”æˆå‰²åˆ", "ç”Ÿå¾’", "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", "æ ¡èˆ"
            ])
        
        # DataFrameã«å¤‰æ›
        import pandas as pd
        df = pd.DataFrame(data["progress"])
        
        if not df.empty:
            # JSONå½¢å¼ã‹ã‚‰CSVäº’æ›å½¢å¼ã¸ã®å¤‰æ›
            column_mapping = {
                "student_name": "ç”Ÿå¾’",
                "planned": "äºˆå®š", 
                "completed": "é”æˆæ¸ˆ",
                "achievement_percentage": "é”æˆå‰²åˆ",
                "route_level": "ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«",
                "subject": "ç§‘ç›®",
                "book_name": "å‚è€ƒæ›¸å",
                "time_hours": "æ‰€è¦æ™‚é–“",
                "campus": "æ ¡èˆ"
            }
            
            for json_col, csv_col in column_mapping.items():
                if json_col in df.columns:
                    if json_col == "achievement_percentage":
                        # ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸å½¢å¼ã«å¤‰æ›
                        df[csv_col] = df[json_col].apply(lambda x: f"{x}%" if pd.notna(x) and x > 0 else "")
                    elif json_col == "time_hours":
                        # æ•°å€¤å‹ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
                        df[csv_col] = df[json_col].astype(str)
                    else:
                        df[csv_col] = df[json_col]
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç”Ÿå¾’åã‹ã‚‰è¨­å®š
            if "ç”Ÿå¾’" in df.columns:
                df["ãƒ¦ãƒ¼ã‚¶ãƒ¼å"] = df["ç”Ÿå¾’"]
            
            # å¿…è¦ãªåˆ—ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ç©ºæ–‡å­—ã§åŸ‹ã‚ã‚‹
            required_columns = ["ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«", "ç§‘ç›®", "å‚è€ƒæ›¸å", "æ‰€è¦æ™‚é–“", "äºˆå®š", "é”æˆæ¸ˆ", 
                              "é”æˆå‰²åˆ", "ç”Ÿå¾’", "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", "æ ¡èˆ"]
            for col in required_columns:
                if col not in df.columns:
                    df[col] = ""
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            if user_filter and "ç”Ÿå¾’" in user_filter:
                filter_value = user_filter["ç”Ÿå¾’"]
                if "ç”Ÿå¾’" in df.columns:
                    df = df[df["ç”Ÿå¾’"] == filter_value]
        
        return df
        
    except Exception as e:
        print(f"âŒ load_json_data ã‚¨ãƒ©ãƒ¼: {e}")
        import pandas as pd
        return pd.DataFrame(columns=[
            "ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«", "ç§‘ç›®", "å‚è€ƒæ›¸å", "æ‰€è¦æ™‚é–“", "äºˆå®š", "é”æˆæ¸ˆ", 
            "é”æˆå‰²åˆ", "ç”Ÿå¾’", "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", "æ ¡èˆ"
        ])


def save_json_data_full(df):
    """
    CSVäº’æ›æ€§ã®ãŸã‚ã®JSONå®Œå…¨ä¿å­˜é–¢æ•°
    
    Args:
        df: ä¿å­˜ã™ã‚‹DataFrame
        
    Returns:
        bool: ä¿å­˜æˆåŠŸãƒ•ãƒ©ã‚°
    """
    try:
        # DataFrameã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
        progress_data = []
        
        if not df.empty:
            for _, row in df.iterrows():
                # CSVå½¢å¼ã‹ã‚‰JSONå½¢å¼ã¸ã®å¤‰æ›
                progress_item = {
                    "id": f"progress_{len(progress_data) + 1:06d}",
                    "student_name": row.get("ç”Ÿå¾’", ""),
                    "book_id": f"book_{len(progress_data) + 1:06d}",  # ç°¡æ˜“çš„ãªbook_id
                    "planned": bool(row.get("äºˆå®š", False)),
                    "completed": bool(row.get("é”æˆæ¸ˆ", False)),
                    "achievement_percentage": float(
                        str(row.get("é”æˆå‰²åˆ", "")).replace("%", "") or 0
                    ),
                    "last_updated": datetime.now().isoformat(),
                    # è¿½åŠ æƒ…å ±
                    "route_level": row.get("ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«", ""),
                    "subject": row.get("ç§‘ç›®", ""),
                    "book_name": row.get("å‚è€ƒæ›¸å", ""),
                    "time_hours": float(row.get("æ‰€è¦æ™‚é–“", 0)),
                    "campus": row.get("æ ¡èˆ", "")
                }
                progress_data.append(progress_item)
        
        # ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        if data_manager.data:
            data_manager.data["progress"] = progress_data
            return data_manager.save_data()
        else:
            print("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
            return False
            
    except Exception as e:
        print(f"âŒ save_json_data_full ã‚¨ãƒ©ãƒ¼: {e}")
        return False